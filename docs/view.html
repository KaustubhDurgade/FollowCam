<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FollowCam ‚Äî Viewing</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Viewer: maximize video real estate */
    .video-container video { cursor: pointer; }
    .video-container.theater {
      position: fixed; inset: 0; z-index: 100;
      background: #000;
    }
    .video-container.theater video { object-fit: contain; }
    .video-container.theater .stats-overlay { top: 1rem; left: 1rem; }
    .video-container.theater .fullscreen-btn { bottom: 1rem; right: 1rem; }
    .reconnect-bar {
      position: absolute; bottom: 4rem; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); padding: 0.5rem 1rem; border-radius: 8px;
      color: var(--text-dim); font-size: 0.85rem; z-index: 10; display: none;
      cursor: pointer;
    }
    .reconnect-bar:hover { color: var(--accent); }
  </style>
</head>
<body>
  <div class="page">
    <!-- Top bar -->
    <div class="topbar" id="topbar">
      <a href="index.html" class="logo" style="text-decoration:none;">FollowCam</a>
      <span class="session-id" id="sessionLabel">‚Äî</span>
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Waiting</span>
      </div>
    </div>

    <!-- Video -->
    <div class="video-container" id="videoContainer">
      <video id="remoteVideo" autoplay playsinline></video>

      <!-- Waiting state -->
      <div class="waiting-msg" id="waitingMsg">
        <div class="spinner"></div><br>
        Waiting for sender to connect‚Ä¶<br>
        <small style="color:var(--text-dim)">Session: <span id="waitSessionID"></span></small>
      </div>

      <div class="stats-overlay" id="statsOverlay" style="display:none;"></div>
      <button class="fullscreen-btn" id="btnFullscreen" style="display:none;">‚õ∂ Fullscreen</button>
      <div class="reconnect-bar" id="reconnectBar">Connection lost ‚Äî tap to reconnect</div>
      
      <!-- Debug log -->
      <div id="debugLog" style="position:absolute;top:3rem;left:0.5rem;right:0.5rem;background:rgba(0,0,0,0.85);color:#0f0;font-family:monospace;font-size:10px;padding:0.5rem;border-radius:6px;max-height:200px;overflow-y:auto;z-index:20;display:none;"></div>
    </div>

    <!-- Controls -->
    <div class="controls" id="controls">
      <button class="ctrl-btn" id="btnStats" title="Toggle stats">üìä</button>
      <button class="ctrl-btn" id="btnTheater" title="Theater mode">üñ•</button>
      <button class="ctrl-btn" id="btnVolume" title="Volume">üîä</button>
    </div>
  </div>

  <script src="followcam.js"></script>
  <script>
    const sessionID = new URLSearchParams(window.location.search).get("id") || "default";
    document.getElementById("sessionLabel").textContent = "ID: " + sessionID;
    document.getElementById("waitSessionID").textContent = sessionID;

    const video = document.getElementById("remoteVideo");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const statsOverlay = document.getElementById("statsOverlay");
    const waitingMsg = document.getElementById("waitingMsg");
    const reconnectBar = document.getElementById("reconnectBar");
    const videoContainer = document.getElementById("videoContainer");

    let showStats = true;
    let isMuted = false;

    // Debug logging overlay
    const debugLog = document.getElementById("debugLog");
    const originalConsole = { log: console.log, warn: console.warn, error: console.error };
    let debugLines = [];
    
    function addDebugLine(prefix, ...args) {
      const line = prefix + " " + args.map(a => typeof a === 'object' ? JSON.stringify(a).substring(0,100) : a).join(" ");
      debugLines.push(line);
      if (debugLines.length > 20) debugLines.shift();
      debugLog.innerHTML = debugLines.join("<br>");
      debugLog.style.display = "block";
    }
    
    console.log = function(...args) { addDebugLine("[LOG]", ...args); originalConsole.log(...args); };
    console.warn = function(...args) { addDebugLine("[WARN]", ...args); originalConsole.warn(...args); };
    console.error = function(...args) { addDebugLine("[ERROR]", ...args); originalConsole.error(...args); };

    // ‚îÄ‚îÄ Callbacks ‚îÄ‚îÄ
    FollowCam.onStatusChange = (state) => {
      statusText.textContent = state.charAt(0).toUpperCase() + state.slice(1);
      statusDot.className = "status-dot";

      if (state === "streaming") {
        statusDot.classList.add("connected");
        waitingMsg.style.display = "none";
        reconnectBar.style.display = "none";
        document.getElementById("btnFullscreen").style.display = "block";
      } else if (state === "connected" || state === "connecting") {
        statusDot.classList.add("connecting");
      } else if (state === "disconnected" || state === "failed") {
        reconnectBar.style.display = "block";
      }
    };

    FollowCam.onRemoteStream = (stream) => {
      console.log("[Viewer] Got remote stream, tracks:", stream.getTracks().map(t => t.kind));
      video.srcObject = stream;
      waitingMsg.style.display = "none";

      // Attempt autoplay
      video.play().catch(e => {
        console.warn("Autoplay blocked, user interaction needed:", e);
        video.muted = true;
        video.play();
      });
    };

    FollowCam.onStatsUpdate = (s) => {
      if (!showStats) { statsOverlay.style.display = "none"; return; }
      statsOverlay.style.display = "block";
      statsOverlay.innerHTML = [
        `üìê ${s.resolution}`,
        `üéØ ${s.fps} fps`,
        `üì° ${s.bitrate}`,
        `üé¨ ${s.codec}`,
        `‚è± RTT ${s.rtt}`,
        `üìâ Jitter ${s.jitter}`,
        s.packetsLost > 0 ? `‚ö†Ô∏è Lost: ${s.packetsLost}` : null
      ].filter(Boolean).join("<br>");
    };

    FollowCam.onError = (msg) => {
      console.error("Error:", msg);
    };

    // ‚îÄ‚îÄ Connect ‚îÄ‚îÄ
    function connect() {
      reconnectBar.style.display = "none";
      waitingMsg.style.display = "flex";
      waitingMsg.style.flexDirection = "column";
      waitingMsg.style.alignItems = "center";
      FollowCam.connectSignaling(sessionID, "viewer").catch(e => {
        console.error("Connect failed:", e);
        reconnectBar.style.display = "block";
      });
    }

    connect();

    // ‚îÄ‚îÄ Reconnect ‚îÄ‚îÄ
    reconnectBar.addEventListener("click", () => {
      FollowCam.disconnect();
      connect();
    });

    // ‚îÄ‚îÄ Toggle stats ‚îÄ‚îÄ
    document.getElementById("btnStats").addEventListener("click", () => {
      showStats = !showStats;
      if (!showStats) statsOverlay.style.display = "none";
    });

    // ‚îÄ‚îÄ Theater mode ‚îÄ‚îÄ
    document.getElementById("btnTheater").addEventListener("click", () => {
      videoContainer.classList.toggle("theater");
      if (videoContainer.classList.contains("theater")) {
        document.getElementById("topbar").style.display = "none";
        document.getElementById("controls").style.display = "none";
      } else {
        document.getElementById("topbar").style.display = "flex";
        document.getElementById("controls").style.display = "flex";
      }
    });

    // Exit theater on Escape
    document.addEventListener("keydown", e => {
      if (e.key === "Escape" && videoContainer.classList.contains("theater")) {
        videoContainer.classList.remove("theater");
        document.getElementById("topbar").style.display = "flex";
        document.getElementById("controls").style.display = "flex";
      }
    });

    // ‚îÄ‚îÄ Fullscreen ‚îÄ‚îÄ
    document.getElementById("btnFullscreen").addEventListener("click", () => {
      if (video.requestFullscreen) video.requestFullscreen();
      else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen();
      else if (video.webkitEnterFullscreen) video.webkitEnterFullscreen(); // iOS Safari
    });

    // ‚îÄ‚îÄ Volume ‚îÄ‚îÄ
    document.getElementById("btnVolume").addEventListener("click", () => {
      isMuted = !isMuted;
      video.muted = isMuted;
      document.getElementById("btnVolume").textContent = isMuted ? "üîá" : "üîä";
    });

    // Double-click video for fullscreen
    video.addEventListener("dblclick", () => {
      if (document.fullscreenElement) {
        document.exitFullscreen();
      } else if (video.requestFullscreen) {
        video.requestFullscreen();
      } else if (video.webkitRequestFullscreen) {
        video.webkitRequestFullscreen();
      }
    });
  </script>
</body>
</html>
